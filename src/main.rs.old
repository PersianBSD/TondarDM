//! TondarDM — Phase 2 integrated with probe (final URL + If-Range)

mod ui { pub mod cli; }
mod http { pub mod client; }
mod download { pub mod single; }
mod net { pub mod request; pub mod inspect; pub mod url; }
mod engine {pub mod error; pub mod config; pub mod consts; pub mod prelude; pub mod  types;}
mod util {pub mod format;}
mod iox {pub mod file; pub mod state; }

use crate::engine::prelude::{Result, DmError};   // ← مهم
use crate::net::inspect::{self, ProbeMode};
use crate::net::url::normalize_url;

#[tokio::main]
async fn main() -> Result<()> {
    let args = ui::cli::parse_args();
    let client = http::client::build_client(&args)?;

    /*let meta = inspect::probe_url(&client, &args.url, ProbeMode::Auto)
        .await
        .map_err(|e| DmError::Other(format!("probe failed: {e}")))?;*/
    let normalized = normalize_url(&args.url);
    let meta = inspect::probe_url(&client, &normalized, ProbeMode::Auto)
        .await
        .map_err(|e| DmError::Other(format!("probe failed: {e}")))?;
    
    ui::cli::print_meta(&meta.final_url, &meta.filename, meta.size, meta.accept_ranges);

    if !ui::cli::confirm("Start download now?") {
        println!("Aborted by user.");
        return Ok(());
    }

    println!("Starting single download...");
    // توجه: این match خودش نباید خروجی تابع باشد؛ بعدش یک Ok(()) بدهیم
    match download::single::download_single(
        &client,
        &meta.final_url,
        &meta.filename,
        meta.size,
        meta.accept_ranges,
        if args.if_range { meta.etag.as_deref() } else { None },           // ← با فلگ
        if args.if_range { meta.last_modified.as_deref() } else { None },  // ← با فلگ
    ).await {
        Ok(()) => {
        println!("✅ Download completed: {}", meta.filename);
        }
        Err(DmError::Other(msg)) if msg == "cancelled" => {
            println!("⏸️ Paused by user (state saved).");
        }
        Err(e) => {
            // خطای واقعی به بالا
            return Err(e);
        }

    }
    Ok(())
}